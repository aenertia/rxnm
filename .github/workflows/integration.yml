name: RXNM CI (Native Nspawn)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    name: Systemd Nspawn Suite
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: |
        sudo apt-get update
        # Install systemd-container for machinectl/nspawn and bridge-utils for networking
        # Added shellcheck for static analysis
        sudo apt-get install -y systemd-container bridge-utils dbus-user-session shellcheck
        
        # --- CI HARDENING FIXES ---
        # 1. Disable AppArmor: It blocks nspawn mounts in nested environments
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        
        # 2. Enable IP Forwarding for the bridge
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1
        
        # 3. Ensure Cgroup delegation is clean
        # (GitHub runners use cgroup v2, which is good, but nspawn needs delegation)
        sudo mkdir -p /sys/fs/cgroup/systemd
        sudo mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd || true

    - name: Build & Unit Tests
      run: |
        echo "=== PHASE 1: Build & Unit Tests ==="
        make tiny
        
        # Run linting explicitly (will also fail build if shellcheck finds errors)
        make lint
        
        # Run foundation tests
        export GITHUB_ACTIONS=true
        make test-all

    - name: Run Integration Tests
      run: |
        echo "=== PHASE 2: Integration Tests (Systemd-Nspawn) ==="
        # Run with sudo as creating network bridges/machines requires privileges
        sudo chmod +x tests/integration/run_interop.sh
        sudo ./tests/integration/run_interop.sh
