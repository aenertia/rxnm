name: RXNM CI (Native Nspawn)

on:
  push:
    branches: [ "main", "master", "v1.1.0", "1.1.x-CI", "agentic-review" ]
  pull_request:
    branches: [ "main", "master", "v1.1.0" ]

jobs:
  unit-and-posix:
    name: "Unit Tests & POSIX Compat"
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dash shellcheck valgrind jq

    - name: Build & Unit Tests
      run: |
        echo "=== PHASE 1: Build & Unit Tests ==="
        make tiny
        make lint
        export GITHUB_ACTIONS=true
        make test-all

    - name: "Path B: POSIX/dash compatibility"
      run: |
        echo "=== Step 1: dash -n syntax check on lib/*.sh ==="
        FAIL=0
        for f in lib/*.sh; do
          # rxnm-config-schema.sh uses Bash-only syntax below its POSIX guard.
          # It cannot pass dash -n. We skip it here and explicitly lint it as bash.
          case "$f" in lib/rxnm-config-schema.sh) continue ;; esac
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        for f in bin/rxnm; do
          [ -f "$f" ] || continue
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        [ "$FAIL" -eq 0 ] || { echo "dash -n check failed"; exit 1; }

        echo "=== Step 2: shellcheck strict POSIX on key lib files ==="
        shellcheck --shell=sh --exclude=SC3043 \
          lib/rxnm-utils.sh lib/rxnm-nullify.sh lib/rxnm-routes.sh \
          lib/rxnm-wifi.sh lib/rxnm-system.sh lib/rxnm-roaming.sh || exit 1

        # Explicitly lint the schema file as bash to ensure safety
        shellcheck --shell=bash lib/rxnm-config-schema.sh || exit 1

        echo "=== Step 3b: Full POSIX library source test ==="
        RXNM_SHELL_IS_BASH=false RXNM_AGENT_BIN="/nonexistent/rxnm-agent" \
          dash -c '
            RXNM_LIB_DIR=./lib
            for f in ./lib/rxnm-constants.sh ./lib/rxnm-utils.sh \
                     ./lib/rxnm-system.sh ./lib/rxnm-wifi.sh \
                     ./lib/rxnm-bluetooth.sh ./lib/rxnm-interfaces.sh \
                     ./lib/rxnm-routes.sh ./lib/rxnm-profiles.sh \
                     ./lib/rxnm-templates.sh ./lib/rxnm-nullify.sh \
                     ./lib/rxnm-roaming.sh ./lib/rxnm-virt.sh \
                     ./lib/rxnm-vpn.sh ./lib/rxnm-pppoe.sh \
                     ./lib/rxnm-tunnel.sh ./lib/rxnm-mpls.sh \
                     ./lib/rxnm-ha.sh ./lib/rxnm-plugins.sh \
                     ./lib/rxnm-diagnostics.sh ./lib/rxnm-help.sh; do
              [ -f "$f" ] || continue
              . "$f" || { echo "FAIL: source $f"; exit 1; }
            done
            json_success "{\"test\":\"posix_source_all\"}" | grep -q "success.*true" || exit 1
            echo "POSIX source all: OK"
          ' || exit 1

  integration-wired:
    name: "Integration: Wired & Bridge"
    runs-on: ubuntu-24.04
    needs: unit-and-posix

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y systemd-container bridge-utils dbus-user-session jq kmod
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        sudo chmod +x tests/integration/run_interop.sh
        sudo ./tests/integration/run_interop.sh --skip-wifi

    - name: Cleanup before bundle tests
      if: always()
      run: |
        for m in $(sudo machinectl list --no-legend --no-pager 2>/dev/null | awk '{print $1}'); do
            sudo machinectl terminate "$m" 2>/dev/null || true
        done
        sleep 2
        sudo rm -rf /var/lib/machines/fedora-rxnm-bundle 2>/dev/null || true

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo ./tests/integration/run_rocknix_interop.sh --skip-wifi

    - name: Run Full Combined Bundle Integration Tests
      run: |
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --skip-wifi

  integration-wifi:
    name: "Integration: Virtual WiFi (hwsim)"
    runs-on: ubuntu-24.04
    needs: unit-and-posix
    continue-on-error: true

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Restore cached hwsim modules
      id: hwsim-cache
      uses: actions/cache@v4
      with:
        path: /tmp/hwsim-cache
        key: hwsim-modules-${{ runner.os }}-${{ hashFiles('/proc/version') }}
        restore-keys: |
          hwsim-modules-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y linux-headers-$(uname -r) build-essential iw rfkill jq systemd-container bridge-utils dbus-user-session kmod curl bc libssl-dev libelf-dev libdw-dev flex bison dpkg-dev

        sudo mkdir -p /etc/NetworkManager/conf.d
        printf '[keyfile]\nunmanaged-devices=driver:mac80211_hwsim\n' | sudo tee /etc/NetworkManager/conf.d/99-hwsim-ignore.conf >/dev/null
        sudo systemctl reload-or-restart NetworkManager || true
        sudo systemctl stop wpa_supplicant 2>/dev/null || true
        sudo systemctl mask wpa_supplicant || true

        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi

        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

    - name: "Load mac80211_hwsim (Stage 1: prebuilt, Stage 2: cache/compile)"
      run: |
        HWSIM_LOADED=false

        #---------------------------------------------------------------
        # Stage 1: Try prebuilt modules from the running kernel
        #---------------------------------------------------------------
        echo "=== Stage 1: Attempting prebuilt modprobe ==="
        REQUIRED_MODULES="pkcs8_key_parser arc4 md4 cmac ecb des3_ede algif_skcipher algif_hash af_alg cfg80211 mac80211 rfkill ccm cbc sha256_generic sha512_generic mac80211_hwsim"
        MISSING_MODULES=""

        for mod in $REQUIRED_MODULES; do
          if ! sudo modprobe "$mod" 2>/dev/null; then
            MISSING_MODULES="$MISSING_MODULES $mod"
          fi
        done

        if [ -n "$MISSING_MODULES" ]; then
            echo "Missing: $MISSING_MODULES"
            echo "Installing linux-modules-extra packages..."
            sudo apt-get install -y "linux-modules-extra-$(uname -r)" 2>/dev/null || true
            # Try azure-specific package as fallback
            sudo apt-get install -y linux-modules-extra-azure 2>/dev/null || true

            MISSING_MODULES=""
            for mod in $REQUIRED_MODULES; do
              if ! sudo modprobe "$mod" 2>/dev/null; then
                MISSING_MODULES="$MISSING_MODULES $mod"
              fi
            done
        fi

        if lsmod | grep -q mac80211_hwsim; then
            echo "Stage 1 SUCCESS: mac80211_hwsim loaded from prebuilt modules"
            HWSIM_LOADED=true
        fi

        #---------------------------------------------------------------
        # Stage 2: Restore from cache or compile from kernel.org source
        #---------------------------------------------------------------
        if [ "$HWSIM_LOADED" = "false" ]; then
            echo "=== Stage 2: Cache/Compile path ==="
            CACHE_DIR="/tmp/hwsim-cache"

            # 2a: Try restoring from actions/cache
            if [ -d "$CACHE_DIR" ] && [ -n "$(ls -A "$CACHE_DIR"/*.ko 2>/dev/null)" ]; then
                echo "Cache HIT: Restoring compiled modules from cache..."
                sudo mkdir -p "/lib/modules/$(uname -r)/updates"
                sudo cp "$CACHE_DIR"/*.ko "/lib/modules/$(uname -r)/updates/"
                sudo depmod -a

                # Verify vermagic before loading
                for ko in "$CACHE_DIR"/*.ko; do
                    echo "  $(basename "$ko"): $(modinfo -F vermagic "$ko" 2>/dev/null || echo 'unknown')"
                done

                for mod in pkcs8_key_parser arc4 md4 cmac ecb des_generic algif_skcipher algif_hash af_alg cfg80211 mac80211 rfkill ccm cbc sha256_generic sha512_generic; do
                    sudo modprobe "$mod" 2>/dev/null || true
                done
                sudo modprobe mac80211_hwsim radios=2 2>/dev/null || true

                if lsmod | grep -q mac80211_hwsim; then
                    echo "Stage 2a SUCCESS: mac80211_hwsim loaded from cached modules"
                    HWSIM_LOADED=true
                else
                    echo "Cache STALE: vermagic mismatch, clearing cache and recompiling..."
                    rm -rf "$CACHE_DIR"
                fi
            fi

            # 2b: Compile ONLY missing modules from kernel.org source
            if [ "$HWSIM_LOADED" = "false" ]; then
                echo "Cache MISS: Compiling missing modules from kernel.org source..."
                echo "Still missing: $MISSING_MODULES"
                mkdir -p /tmp/linux-src
                cd /tmp/linux-src

                KVER=$(uname -r | cut -d- -f1)
                KVER_MAJ_MIN=$(echo "$KVER" | sed 's/\.0$//')
                MAJOR=$(echo "$KVER" | cut -d. -f1)
                URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${KVER_MAJ_MIN}.tar.xz"

                echo "Downloading $URL..."
                if ! curl -fSsl -O "$URL"; then
                    echo "::warning::Failed to download kernel source from $URL"
                    echo "HWSIM_FAILED=true" >> "$GITHUB_ENV"
                    exit 0
                fi
                tar -xf "linux-${KVER_MAJ_MIN}.tar.xz"
                cd "linux-${KVER_MAJ_MIN}"

                echo "Preparing build environment for $(uname -r)..."

                FULL_VER=$(uname -r)
                EXTRA_VER=${FULL_VER#"$KVER"}
                sed -i "s/^EXTRAVERSION.*/EXTRAVERSION = $EXTRA_VER/" Makefile
                echo "Set EXTRAVERSION to '$EXTRA_VER'"

                if [ -f "/boot/config-$(uname -r)" ]; then
                    cp "/boot/config-$(uname -r)" .config
                else
                    echo "::warning::No /boot/config found, using defconfig"
                    make defconfig
                fi

                # Module.symvers is CRITICAL - without it all symbols are unresolved
                echo "=== Searching for Module.symvers ==="
                SYMVERS_FOUND=false
                for sympath in "/usr/src/linux-headers-$(uname -r)/Module.symvers" "/lib/modules/$(uname -r)/build/Module.symvers" "/usr/src/linux-headers-$(uname -r | sed 's/-azure//')/Module.symvers"; do
                    echo "  Checking: $sympath"
                    if [ -f "$sympath" ]; then
                        cp "$sympath" .
                        echo "  FOUND: Module.symvers from $sympath ($(wc -l < Module.symvers) symbols)"
                        SYMVERS_FOUND=true
                        break
                    fi
                done
                if [ "$SYMVERS_FOUND" = "false" ]; then
                    echo "::warning::Module.symvers not found - listing available header dirs:"
                    ls -la /usr/src/ 2>/dev/null || true
                    ls -la /lib/modules/$(uname -r)/ 2>/dev/null || true
                fi

                # Append required module configs
                printf '%s\n' "CONFIG_WLAN=y" "CONFIG_WIRELESS=y" "CONFIG_NETDEVICES=y" "CONFIG_PKCS8_PRIVATE_KEY_PARSER=m" "CONFIG_CRYPTO_ARC4=m" "CONFIG_CRYPTO_MD4=m" "CONFIG_CRYPTO_CMAC=m" "CONFIG_CRYPTO_ECB=m" "CONFIG_CRYPTO_DES=m" "CONFIG_CRYPTO_USER_API_SKCIPHER=m" "CONFIG_CRYPTO_USER_API_HASH=m" "CONFIG_CRYPTO_USER_API=m" "CONFIG_CFG80211=m" "CONFIG_MAC80211=m" "CONFIG_RFKILL=m" "CONFIG_CRYPTO_CCM=m" "CONFIG_CRYPTO_CBC=m" "CONFIG_CRYPTO_SHA256=m" "CONFIG_CRYPTO_SHA512=m" "CONFIG_MAC80211_HWSIM=m" >> .config

                make olddefconfig
                make modules_prepare || make scripts || true

                # Dynamically locate hwsim source (moved to virtual/ in 6.x kernels)
                HWSIM_SRC=$(find drivers/net/wireless -name "mac80211_hwsim.c" | head -n1)
                HWSIM_KO="${HWSIM_SRC%.c}.ko"

                # Build only the specific modules that are missing
                TARGETS=""
                for mod in $MISSING_MODULES; do
                    case "$mod" in
                        arc4) TARGETS="$TARGETS crypto/arc4.ko" ;;
                        md4) TARGETS="$TARGETS crypto/md4.ko" ;;
                        cmac) TARGETS="$TARGETS crypto/cmac.ko" ;;
                        ecb) TARGETS="$TARGETS crypto/ecb.ko" ;;
                        des3_ede|des_generic) TARGETS="$TARGETS crypto/des_generic.ko" ;;
                        algif_skcipher) TARGETS="$TARGETS crypto/algif_skcipher.ko" ;;
                        algif_hash) TARGETS="$TARGETS crypto/algif_hash.ko" ;;
                        af_alg) TARGETS="$TARGETS crypto/af_alg.ko" ;;
                        ccm) TARGETS="$TARGETS crypto/ccm.ko" ;;
                        cbc) TARGETS="$TARGETS crypto/cbc.ko" ;;
                        sha256_generic) TARGETS="$TARGETS crypto/sha256_generic.ko" ;;
                        sha512_generic) TARGETS="$TARGETS crypto/sha512_generic.ko" ;;
                        pkcs8_key_parser) TARGETS="$TARGETS crypto/asymmetric_keys/pkcs8_key_parser.ko" ;;
                        rfkill) TARGETS="$TARGETS net/rfkill/rfkill.ko" ;;
                        cfg80211) TARGETS="$TARGETS net/wireless/cfg80211.ko" ;;
                        mac80211) TARGETS="$TARGETS net/mac80211/mac80211.ko" ;;
                        mac80211_hwsim) TARGETS="$TARGETS $HWSIM_KO" ;;
                    esac
                done

                echo "Building ONLY missing modules: $TARGETS"
                make KBUILD_MODPOST_WARN=1 -j"$(nproc)" $TARGETS || echo "::warning::Some module targets failed to build"

                # Install compiled modules and cache for next run
                sudo mkdir -p "/lib/modules/$(uname -r)/updates"
                mkdir -p "$CACHE_DIR"

                find . -name "*.ko" | while IFS= read -r ko; do
                    echo "  Installing: $(basename "$ko") vermagic=$(modinfo -F vermagic "$ko" 2>/dev/null || echo N/A)"
                    sudo cp "$ko" "/lib/modules/$(uname -r)/updates/"
                    cp "$ko" "$CACHE_DIR/"
                done
                sudo depmod -a

                for mod in pkcs8_key_parser arc4 md4 cmac ecb des_generic algif_skcipher algif_hash af_alg cfg80211 mac80211 rfkill ccm cbc sha256_generic sha512_generic; do
                    sudo modprobe "$mod" 2>/dev/null || true
                done
                sudo modprobe mac80211_hwsim radios=2 2>/dev/null || true

                if lsmod | grep -q mac80211_hwsim; then
                    echo "Stage 2b SUCCESS: mac80211_hwsim loaded from compiled modules"
                    HWSIM_LOADED=true
                fi
            fi
        fi

        #---------------------------------------------------------------
        # Final status
        #---------------------------------------------------------------
        if [ "$HWSIM_LOADED" = "true" ]; then
            echo "HWSIM_FAILED=false" >> "$GITHUB_ENV"
            echo "::notice::mac80211_hwsim loaded successfully"
            lsmod | grep -E "mac80211|cfg80211|hwsim"
        else
            echo "HWSIM_FAILED=true" >> "$GITHUB_ENV"
            echo "::warning::mac80211_hwsim failed to load on this runner"
            echo "--- dmesg (last 40 lines) ---"
            sudo dmesg | tail -n 40
            echo "--- modinfo for cached .ko files ---"
            if ls /tmp/hwsim-cache/*.ko >/dev/null 2>&1; then
                for ko in /tmp/hwsim-cache/*.ko; do
                    [ -f "$ko" ] && echo "  $(basename "$ko"): vermagic=$(modinfo -F vermagic "$ko" 2>/dev/null || echo 'N/A')"
                done
            fi
            echo "Running kernel: $(uname -r)"
        fi

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        sudo chmod +x tests/integration/run_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then
            echo "::warning::Skipping WiFi tests (hwsim unavailable)"
            sudo ./tests/integration/run_interop.sh --skip-wifi
        else
            sudo ./tests/integration/run_interop.sh --wifi-only
        fi

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then
            sudo ./tests/integration/run_rocknix_interop.sh --skip-wifi
        else
            sudo ./tests/integration/run_rocknix_interop.sh --wifi-only
        fi

    - name: Run Full Combined Bundle Integration Tests
      run: |
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then
            sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --skip-wifi
        else
            sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --wifi-only
        fi
