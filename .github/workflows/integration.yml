name: RXNM CI (Native Nspawn)

on:
  push:
    branches: [ "main", "master", "v1.1.0" ]
  pull_request:
    branches: [ "main", "master", "v1.1.0" ]

jobs:
  unit-and-posix:
    name: "Unit Tests & POSIX Compat"
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dash shellcheck valgrind jq

    - name: Build & Unit Tests
      run: |
        echo "=== PHASE 1: Build & Unit Tests ==="
        make tiny
        
        # Run linting explicitly (will also fail build if shellcheck finds errors)
        make lint
        
        # Run foundation tests
        export GITHUB_ACTIONS=true
        make test-all

    - name: "Path B: POSIX/dash compatibility"
      run: |
        echo "=== Step 1: dash -n syntax check on lib/*.sh ==="
        FAIL=0
        for f in lib/*.sh; do
          # rxnm-config-schema.sh uses Bash-only syntax below its POSIX guard.
          case "$f" in lib/rxnm-config-schema.sh) continue ;; esac
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        for f in bin/rxnm; do
          [ -f "$f" ] || continue
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        [ "$FAIL" -eq 0 ] || { echo "dash -n check failed"; exit 1; }

        echo "=== Step 2: shellcheck strict POSIX on key lib files ==="
        shellcheck --shell=sh --exclude=SC3043 \
          lib/rxnm-utils.sh lib/rxnm-nullify.sh lib/rxnm-routes.sh \
          lib/rxnm-wifi.sh lib/rxnm-system.sh lib/rxnm-roaming.sh || exit 1

        echo "=== Step 3b: Full POSIX library source test ==="
        RXNM_SHELL_IS_BASH=false RXNM_AGENT_BIN="/nonexistent/rxnm-agent" \
          dash -c '
            RXNM_LIB_DIR=./lib
            for f in ./lib/rxnm-constants.sh ./lib/rxnm-utils.sh \
                     ./lib/rxnm-system.sh ./lib/rxnm-wifi.sh \
                     ./lib/rxnm-bluetooth.sh ./lib/rxnm-interfaces.sh \
                     ./lib/rxnm-routes.sh ./lib/rxnm-profiles.sh \
                     ./lib/rxnm-templates.sh ./lib/rxnm-nullify.sh \
                     ./lib/rxnm-roaming.sh ./lib/rxnm-virt.sh \
                     ./lib/rxnm-vpn.sh ./lib/rxnm-pppoe.sh \
                     ./lib/rxnm-tunnel.sh ./lib/rxnm-mpls.sh \
                     ./lib/rxnm-ha.sh ./lib/rxnm-plugins.sh \
                     ./lib/rxnm-diagnostics.sh ./lib/rxnm-help.sh; do
              [ -f "$f" ] || continue
              . "$f" || { echo "FAIL: source $f"; exit 1; }
            done
            json_success "{\"test\":\"posix_source_all\"}" | grep -q "success.*true" || exit 1
            echo "POSIX source all: OK"
          ' || exit 1

  integration-wired:
    name: "Integration: Wired & Bridge"
    runs-on: ubuntu-24.04
    needs: unit-and-posix
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: |
        # Install systemd-container for machinectl/nspawn and bridge-utils for networking
        sudo apt-get update
        sudo apt-get install -y systemd-container bridge-utils dbus-user-session jq
        
        # --- CI HARDENING FIXES ---
        # 1. Disable AppArmor: It blocks nspawn mounts in nested environments
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        
        # 2. Enable IP Forwarding for the bridge
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        echo "=== PHASE 4: Standard Integration Tests (Wired) ==="
        sudo chmod +x tests/integration/run_interop.sh
        sudo ./tests/integration/run_interop.sh --skip-wifi

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        echo "=== PHASE 5: ROCKNIX Bundle Integration Tests (Wired) ==="
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo ./tests/integration/run_rocknix_interop.sh --skip-wifi

    - name: Run Full Combined Bundle Integration Tests
      run: |
        echo "=== PHASE 6: Full Combined Bundle Integration Tests (Wired) ==="
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --skip-wifi

  integration-wifi:
    name: "Integration: Virtual WiFi (hwsim)"
    runs-on: ubuntu-24.04
    needs: unit-and-posix
    continue-on-error: true   # hwsim is best-effort on cloud runners
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Compile and Load Virtual WiFi (mac80211_hwsim)
      run: |
        echo "=== Setting up Virtual WiFi for Azure Kernel ==="
        sudo apt-get update
        sudo apt-get install -y linux-headers-$(uname -r) build-essential iw rfkill || true
        
        # CRITICAL FIX: Always load kernel crypto and 80211 dependencies FIRST.
        # insmod (used below) does not resolve dependencies automatically like modprobe.
        # Without these, insmod fails with 'Unknown symbol in module'.
        for mod in pkcs8_key_parser arc4 md4 cmac ecb des3_ede \
                    algif_skcipher algif_hash af_alg cfg80211 mac80211 \
                    rfkill ccm cbc sha256_generic sha512_generic; do
          sudo modprobe "$mod" >/dev/null 2>&1 || true
        done
        
        # Fast path: try native modprobe first
        if sudo modprobe mac80211_hwsim radios=2 2>/dev/null; then
          echo "HWSIM_METHOD=modprobe" >> $GITHUB_ENV
        else
          echo "Native modprobe failed. Fetching source and compiling out-of-tree..."
          
          # Map e.g. 6.11.0-1018-azure -> 6.11
          BASE_VER=$(uname -r | cut -d'.' -f1,2)
          mkdir -p /tmp/hwsim && cd /tmp/hwsim
          
          URL_BASE="https://raw.githubusercontent.com/torvalds/linux/v${BASE_VER}/drivers/net/wireless"
          
          # Try modern path first, then fallback to older pre-virtualization location
          wget -q "$URL_BASE/virtual/mac80211_hwsim.c" -O mac80211_hwsim.c || \
          wget -q "$URL_BASE/mac80211_hwsim.c" -O mac80211_hwsim.c
          
          # Grab header if it exists in this tree version
          wget -q "$URL_BASE/virtual/mac80211_hwsim.h" -O mac80211_hwsim.h || \
          wget -q "$URL_BASE/mac80211_hwsim.h" -O mac80211_hwsim.h || true
          
          if [ -s mac80211_hwsim.c ]; then
              echo "obj-m += mac80211_hwsim.o" > Makefile
              sudo make -C /lib/modules/$(uname -r)/build M=$(pwd) modules
              sudo insmod ./mac80211_hwsim.ko radios=2
              echo "HWSIM_METHOD=compiled" >> $GITHUB_ENV
          else
              echo "ERROR: Failed to fetch mac80211_hwsim.c for v${BASE_VER}"
              exit 1
          fi
        fi

        # Block NM from grabbing hwsim interfaces BEFORE they appear
        sudo mkdir -p /etc/NetworkManager/conf.d
        echo -e "[keyfile]\nunmanaged-devices=driver:mac80211_hwsim" \
          | sudo tee /etc/NetworkManager/conf.d/99-hwsim-ignore.conf >/dev/null
        sudo systemctl reload-or-restart NetworkManager || true
        sleep 1

        sudo systemctl stop wpa_supplicant 2>/dev/null || true
        sudo systemctl mask wpa_supplicant || true

        # Force interfaces DOWN so nspawn can claim them cleanly
        sleep 2
        for iface in $(iw dev | awk '$1=="Interface"{print $2}'); do
          sudo ip link set "$iface" down
        done

        sudo rfkill unblock all || true
        lsmod | grep mac80211_hwsim || true
        iw dev || true

    - name: Prepare Host Environment
      run: |
        sudo apt-get install -y systemd-container bridge-utils dbus-user-session jq
        
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        echo "=== PHASE 4: Standard Integration Tests (WiFi Only) ==="
        sudo chmod +x tests/integration/run_interop.sh
        sudo ./tests/integration/run_interop.sh --wifi-only

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        echo "=== PHASE 5: ROCKNIX Bundle Integration Tests (WiFi Only) ==="
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo ./tests/integration/run_rocknix_interop.sh --wifi-only

    - name: Run Full Combined Bundle Integration Tests
      run: |
        echo "=== PHASE 6: Full Combined Bundle Integration Tests (WiFi Only) ==="
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --wifi-only
