name: RXNM CI (Native Nspawn)

on:
  push:
    branches: [ "main", "master", "v1.1.0" ]
  pull_request:
    branches: [ "main", "master", "v1.1.0" ]

jobs:
  unit-and-posix:
    name: "Unit Tests & POSIX Compat"
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dash shellcheck valgrind jq

    - name: Build & Unit Tests
      run: |
        echo "=== PHASE 1: Build & Unit Tests ==="
        make tiny
        make lint
        export GITHUB_ACTIONS=true
        make test-all

    - name: "Path B: POSIX/dash compatibility"
      run: |
        echo "=== Step 1: dash -n syntax check on lib/*.sh ==="
        FAIL=0
        for f in lib/*.sh; do
          # rxnm-config-schema.sh uses Bash-only syntax below its POSIX guard.
          # It cannot pass dash -n. We skip it here and explicitly lint it as bash.
          case "$f" in lib/rxnm-config-schema.sh) continue ;; esac
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        for f in bin/rxnm; do
          [ -f "$f" ] || continue
          if ! dash -n "$f"; then
            echo "POSIX FAIL [dash -n]: $f"
            FAIL=1
          fi
        done
        [ "$FAIL" -eq 0 ] || { echo "dash -n check failed"; exit 1; }

        echo "=== Step 2: shellcheck strict POSIX on key lib files ==="
        shellcheck --shell=sh --exclude=SC3043 \
          lib/rxnm-utils.sh lib/rxnm-nullify.sh lib/rxnm-routes.sh \
          lib/rxnm-wifi.sh lib/rxnm-system.sh lib/rxnm-roaming.sh || exit 1
          
        # Explicitly lint the schema file as bash to ensure safety
        shellcheck --shell=bash lib/rxnm-config-schema.sh || exit 1

        echo "=== Step 3b: Full POSIX library source test ==="
        RXNM_SHELL_IS_BASH=false RXNM_AGENT_BIN="/nonexistent/rxnm-agent" \
          dash -c '
            RXNM_LIB_DIR=./lib
            for f in ./lib/rxnm-constants.sh ./lib/rxnm-utils.sh \
                     ./lib/rxnm-system.sh ./lib/rxnm-wifi.sh \
                     ./lib/rxnm-bluetooth.sh ./lib/rxnm-interfaces.sh \
                     ./lib/rxnm-routes.sh ./lib/rxnm-profiles.sh \
                     ./lib/rxnm-templates.sh ./lib/rxnm-nullify.sh \
                     ./lib/rxnm-roaming.sh ./lib/rxnm-virt.sh \
                     ./lib/rxnm-vpn.sh ./lib/rxnm-pppoe.sh \
                     ./lib/rxnm-tunnel.sh ./lib/rxnm-mpls.sh \
                     ./lib/rxnm-ha.sh ./lib/rxnm-plugins.sh \
                     ./lib/rxnm-diagnostics.sh ./lib/rxnm-help.sh; do
              [ -f "$f" ] || continue
              . "$f" || { echo "FAIL: source $f"; exit 1; }
            done
            json_success "{\"test\":\"posix_source_all\"}" | grep -q "success.*true" || exit 1
            echo "POSIX source all: OK"
          ' || exit 1

  integration-wired:
    name: "Integration: Wired & Bridge"
    runs-on: ubuntu-24.04
    needs: unit-and-posix
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y systemd-container bridge-utils dbus-user-session jq kmod
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        sudo chmod +x tests/integration/run_interop.sh
        sudo ./tests/integration/run_interop.sh --skip-wifi

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo ./tests/integration/run_rocknix_interop.sh --skip-wifi

    - name: Run Full Combined Bundle Integration Tests
      run: |
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --skip-wifi

  integration-wifi:
    name: "Integration: Virtual WiFi (hwsim)"
    runs-on: ubuntu-24.04
    needs: unit-and-posix
    continue-on-error: true   
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Compile and Load Dependencies & Virtual WiFi
      run: |
        sudo apt-get update
        sudo apt-get install -y linux-headers-$(uname -r) build-essential iw rfkill jq systemd-container bridge-utils dbus-user-session kmod curl bc libssl-dev libelf-dev flex bison dpkg-dev
        
        sudo mkdir -p /etc/NetworkManager/conf.d
        echo -e "[keyfile]\nunmanaged-devices=driver:mac80211_hwsim" | sudo tee /etc/NetworkManager/conf.d/99-hwsim-ignore.conf >/dev/null
        sudo systemctl reload-or-restart NetworkManager || true
        sudo systemctl stop wpa_supplicant 2>/dev/null || true
        sudo systemctl mask wpa_supplicant || true
        
        if systemctl is-active --quiet apparmor; then
            sudo systemctl stop apparmor
            sudo systemctl disable apparmor
        fi
        
        sudo sysctl -w net.ipv4.ip_forward=1
        sudo sysctl -w net.ipv6.conf.all.forwarding=1

        echo "Sweeping required modules..."
        REQUIRED_MODULES="pkcs8_key_parser arc4 md4 cmac ecb des3_ede algif_skcipher algif_hash af_alg cfg80211 mac80211 rfkill ccm cbc sha256_generic sha512_generic mac80211_hwsim"
        MISSING_MODULES=""
        
        for mod in $REQUIRED_MODULES; do
          if ! sudo modprobe "$mod" 2>/dev/null; then
            MISSING_MODULES="$MISSING_MODULES $mod"
          fi
        done
        
        # Fast path: Try installing prebuilt extra modules if missing
        if [ -n "$MISSING_MODULES" ]; then
            echo "Attempting to install precompiled linux-modules-extra..."
            sudo apt-get install -y linux-modules-extra-$(uname -r) linux-modules-extra-azure || true
            
            # Re-sweep
            MISSING_MODULES=""
            for mod in $REQUIRED_MODULES; do
              if ! sudo modprobe "$mod" 2>/dev/null; then
                MISSING_MODULES="$MISSING_MODULES $mod"
              fi
            done
        fi
        
        # Strict Compilation Path
        if [ -n "$MISSING_MODULES" ]; then
            echo "Missing modules still detected: $MISSING_MODULES"
            echo "Strictly compiling missing modules from exact Ubuntu kernel source..."
            
            # Enable source repos for DEB822 format (Ubuntu 24.04+)
            sudo sed -i 's/Types: deb/Types: deb deb-src/g' /etc/apt/sources.list.d/ubuntu.sources || true
            sudo apt-get update
            
            mkdir -p /tmp/linux-src
            cd /tmp/linux-src
            
            KVER=$(uname -r | cut -d- -f1) # e.g., 6.11.0
            SRC_DIR=""
            
            echo "Strategy 1: Attempting apt-get source on specific kernel packages..."
            for pkg in "linux-image-unsigned-$(uname -r)" "linux-modules-$(uname -r)" "linux-azure"; do
                echo "Trying: apt-get source $pkg"
                apt-get source "$pkg" || true
                SRC_DIR=$(find . -maxdepth 1 -type d -name "linux-*" | while read dir; do [ -f "$dir/Makefile" ] && echo "$dir"; done | head -n1)
                if [ -n "$SRC_DIR" ]; then
                    echo "✓ Found valid source tree in $SRC_DIR"
                    break
                fi
                echo "✗ No valid source tree found, cleaning up..."
                rm -rf ./*
            done
            
            if [ -z "$SRC_DIR" ]; then
                echo "Strategy 2: Attempting to install and extract linux-source package..."
                sudo apt-get install -y "linux-source-$KVER" || sudo apt-get install -y linux-source || true
                TARBALL=$(ls /usr/src/linux-source-$KVER*.tar.* 2>/dev/null | head -n1 || ls /usr/src/linux-source-*.tar.* 2>/dev/null | head -n1)
                if [ -n "$TARBALL" ] && [ -f "$TARBALL" ]; then
                    echo "Extracting $TARBALL..."
                    tar -xf "$TARBALL"
                    SRC_DIR=$(find . -maxdepth 1 -type d -name "linux-source-*" | while read dir; do [ -f "$dir/Makefile" ] && echo "$dir"; done | head -n1)
                    if [ -n "$SRC_DIR" ]; then
                        echo "✓ Successfully extracted source tree from $TARBALL"
                    fi
                fi
            fi
            
            if [ -z "$SRC_DIR" ]; then
                echo "Strategy 3: Fallback to generic linux source..."
                apt-get source linux || true
                SRC_DIR=$(find . -maxdepth 1 -type d -name "linux-*" | while read dir; do [ -f "$dir/Makefile" ] && echo "$dir"; done | head -n1)
            fi
            
            if [ -z "$SRC_DIR" ]; then
                echo "::error::Failed to download or extract a valid kernel source tree."
                exit 1
            fi
            cd "$SRC_DIR"
            
            echo "Preparing kernel build environment for $(uname -r)..."
            cp /boot/config-$(uname -r) .config
            cp /usr/src/linux-headers-$(uname -r)/Module.symvers . || true
            
            # Force module configs to guarantee compilation
            cat <<EOF >> .config
        CONFIG_PKCS8_PRIVATE_KEY_PARSER=m
        CONFIG_CRYPTO_ARC4=m
        CONFIG_CRYPTO_MD4=m
        CONFIG_CRYPTO_CMAC=m
        CONFIG_CRYPTO_ECB=m
        CONFIG_CRYPTO_DES=m
        CONFIG_CRYPTO_USER_API_SKCIPHER=m
        CONFIG_CRYPTO_USER_API_HASH=m
        CONFIG_CRYPTO_USER_API=m
        CONFIG_CFG80211=m
        CONFIG_MAC80211=m
        CONFIG_RFKILL=m
        CONFIG_CRYPTO_CCM=m
        CONFIG_CRYPTO_CBC=m
        CONFIG_CRYPTO_SHA256=m
        CONFIG_CRYPTO_SHA512=m
        CONFIG_MAC80211_HWSIM=m
        EOF
            
            # No sudo needed for compilation, keeping files owned by runner
            make olddefconfig
            make modules_prepare
            
            for mod in $MISSING_MODULES; do
                DIR=""
                CONFIG_VAR=""
                case "$mod" in
                    pkcs8_key_parser) DIR="crypto/asymmetric_keys"; CONFIG_VAR="CONFIG_PKCS8_PRIVATE_KEY_PARSER" ;;
                    arc4) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_ARC4" ;;
                    md4) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_MD4" ;;
                    cmac) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_CMAC" ;;
                    ecb) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_ECB" ;;
                    des3_ede) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_DES" ;;
                    algif_skcipher) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_USER_API_SKCIPHER" ;;
                    algif_hash) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_USER_API_HASH" ;;
                    af_alg) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_USER_API" ;;
                    cfg80211) DIR="net/wireless"; CONFIG_VAR="CONFIG_CFG80211" ;;
                    mac80211) DIR="net/mac80211"; CONFIG_VAR="CONFIG_MAC80211" ;;
                    rfkill) DIR="net/rfkill"; CONFIG_VAR="CONFIG_RFKILL" ;;
                    ccm) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_CCM" ;;
                    cbc) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_CBC" ;;
                    sha256_generic) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_SHA256" ;;
                    sha512_generic) DIR="crypto"; CONFIG_VAR="CONFIG_CRYPTO_SHA512" ;;
                    mac80211_hwsim) DIR="drivers/net/wireless"; CONFIG_VAR="CONFIG_MAC80211_HWSIM" ;;
                esac
                
                if [ -n "$DIR" ]; then
                    echo "Compiling modules in $DIR for $mod ($CONFIG_VAR=m)..."
                    # Force the config variable directly into make to bypass kconfig dependency drops
                    make -j$(nproc) M=$DIR $CONFIG_VAR=m || echo "::warning::Compilation failed for $DIR"
                    
                    MOD_FILE=$(find $DIR -name "${mod}.ko" -o -name "${mod//_/-}.ko" | head -n1)
                    if [ -n "$MOD_FILE" ]; then
                        if [ "$mod" = "mac80211_hwsim" ]; then
                            sudo insmod "$MOD_FILE" radios=2 || echo "::warning::Failed to load $mod"
                        else
                            sudo insmod "$MOD_FILE" || echo "::warning::Failed to load $mod"
                        fi
                    else
                        echo "::warning::Module file for $mod not found after make M=$DIR!"
                    fi
                fi
            done
        else
            echo "All required modules are already available via modprobe/built-in."
        fi
        
        if lsmod | grep -q mac80211_hwsim; then
           echo "HWSIM_METHOD=compiled" >> $GITHUB_ENV
           echo "HWSIM_FAILED=false" >> $GITHUB_ENV
           echo "✓ Successfully loaded mac80211_hwsim"
        else
           echo "HWSIM_FAILED=true" >> $GITHUB_ENV
           echo "::warning::mac80211_hwsim failed to load."
           sudo dmesg | tail -n 30
        fi

    - name: Build RXNM Agent
      run: make tiny

    - name: Run Integration Tests
      run: |
        sudo chmod +x tests/integration/run_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then sudo ./tests/integration/run_interop.sh --skip-wifi; else sudo ./tests/integration/run_interop.sh --wifi-only; fi

    - name: Run ROCKNIX Bundle Integration Tests
      run: |
        make rocknix-release
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then sudo ./tests/integration/run_rocknix_interop.sh --skip-wifi; else sudo ./tests/integration/run_rocknix_interop.sh --wifi-only; fi

    - name: Run Full Combined Bundle Integration Tests
      run: |
        make combined-full
        sudo chmod +x tests/integration/run_rocknix_interop.sh
        if [ "${HWSIM_FAILED}" = "true" ]; then sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --skip-wifi; else sudo BUNDLE_BIN=build/rxnm-full ./tests/integration/run_rocknix_interop.sh --wifi-only; fi
