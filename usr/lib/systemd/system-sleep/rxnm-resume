#!/bin/bash
# RXNM Suspend/Resume Handler for WiFi Reconnection & Nullify States
# Place in /usr/lib/systemd/system-sleep/ and ensure executable permissions

# Load optional userspace configuration for Nullify behaviors
NULLIFY_ON_SLEEP="false"
if [ -f /storage/.config/network/nullify.conf ]; then
    # shellcheck disable=SC1091
    source /storage/.config/network/nullify.conf
fi

case "$1/$2" in
  pre/*)
    # 1. Check current Nullify state
    current_nullify="disabled"
    if [ -f /run/rocknix/nullify.state ]; then
        read -r current_nullify < /run/rocknix/nullify.state 2>/dev/null || current_nullify="disabled"
    fi

    # 2. Engage "Project Silence" (Nullify) IF configured AND not already manually enabled
    if [ "$NULLIFY_ON_SLEEP" = "true" ] && [ "$current_nullify" != "enabled" ]; then
        logger -t rxnm-resume "Auto-engaging Nullify mode for deep sleep protection"
        
        # Mark that the system sleep hook triggered this, so we know to undo it on resume
        mkdir -p /run/rocknix/resume_state
        touch /run/rocknix/resume_state/auto_nullified
        
        # Engage nullify (this will natively save the BT and WiFi states)
        /usr/bin/rxnm system nullify enable >/dev/null 2>&1
    fi
    ;;
    
  post/*)
    # 1. Revert Auto-Nullify ONLY if the sleep hook triggered it
    if [ -f /run/rocknix/resume_state/auto_nullified ]; then
        logger -t rxnm-resume "Restoring hardware network and Bluetooth stacks (Auto-Nullify Revert)"
        
        # Disable nullify (this will natively restore the BT and WiFi states)
        /usr/bin/rxnm system nullify disable >/dev/null 2>&1
        rm -f /run/rocknix/resume_state/auto_nullified
    fi
    ;;
esac
