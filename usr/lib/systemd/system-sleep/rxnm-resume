#!/bin/bash
# RXNM Suspend/Resume Handler for WiFi Reconnection
# Place in /usr/lib/systemd/system-sleep/ and ensure executable permissions

case "$1/$2" in
  pre/*)
    # Before suspend - save current connection state
    if [ -d /run/rocknix ]; then
        mkdir -p /run/rocknix/resume_state
        
        # Check all wireless interfaces
        for iface in /sys/class/net/*/wireless; do
            [ -e "$iface" ] || continue
            iface_name=$(basename "$(dirname "$iface")")
            
            # If connected, save the SSID
            if command -v iwctl >/dev/null; then
                if iwctl station "$iface_name" show 2>/dev/null | grep -q "Connected network"; then
                    ssid=$(iwctl station "$iface_name" show 2>/dev/null | awk '/Connected network/{$1=$2=""; sub(/^ +/, ""); print}')
                    if [ -n "$ssid" ]; then
                        echo "$ssid" > "/run/rocknix/resume_state/${iface_name}.ssid"
                    fi
                fi
            fi
        done
    fi
    ;;
    
  post/*)
    # After resume - restore connections
    
    # REMEDIATION: Missing iwctl Error Handling & Race Condition
    # Wait for IWD service and interface availability before attempting commands.
    
    # Run restoration routine in an isolated subshell to prevent blocking 
    # the systemd-sleep execution chain and ensure proper timeout handling.
    (
        # Hard timeout to prevent hangs
        timeout 25s bash -c '
        if [ -d /run/rocknix/resume_state ]; then
            
            # Wait up to 10 seconds for IWD to be fully active
            for i in {1..20}; do
                if systemctl is-active --quiet iwd; then
                    break
                fi
                sleep 0.5
            done
            
            for state_file in /run/rocknix/resume_state/*.ssid; do
                [ -e "$state_file" ] || continue
                
                iface_name=$(basename "$state_file" .ssid)
                ssid=$(cat "$state_file")
                
                if [ -n "$ssid" ] && command -v iwctl >/dev/null; then
                    # Ensure the interface exists in sysfs before commanding it
                    if [ -d "/sys/class/net/${iface_name}" ]; then
                        logger -t rxnm-resume "Restoring connection to $ssid on $iface_name"
                        # Use "--" to safely terminate options in case SSID starts with "-"
                        iwctl station "$iface_name" connect -- "$ssid" >/dev/null 2>&1
                    else
                        logger -t rxnm-resume "Interface $iface_name not found after resume, skipping reconnect"
                    fi
                fi
                
                rm -f "$state_file"
            done
        fi
        '
    ) &
    ;;
esac
