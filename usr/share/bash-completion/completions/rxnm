_rxnm_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local prev="${COMP_WORDS[COMP_CWORD-1]}"
    local cmd="${COMP_WORDS[1]}"
    local subcmd="${COMP_WORDS[2]}"

    # Top Level Categories
    local categories="wifi interface bluetooth bridge bond vrf vlan macvlan ipvlan veth vpn tun tap profile system config help"
    local wifi_cmds="scan connect disconnect ap wps networks list forget country"
    local iface_cmds="show set enable disable list"
    local system_cmds="status check proxy reload"
    local profile_cmds="save load list delete export import"
    local virt_cmds="create delete add-member list"
    
    # Flags that can appear anywhere
    if [[ "$cur" == --* ]]; then
        COMPREPLY=($(compgen -W "--json --format --yes --force --debug --help --interface --metric --table --parent --mode --peer --user --group --ssid --password --hidden --share --ip --gateway --dns --http --https --noproxy" -- "$cur"))
        return 0
    fi

    # Level 1: Category Selection
    if [ $COMP_CWORD -eq 1 ]; then
        COMPREPLY=($(compgen -W "$categories" -- "$cur"))
        return 0
    fi

    # Level 2+: Action Selection
    case "$cmd" in
        wifi)
            if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "$wifi_cmds" -- "$cur"))
            else
                 case "$subcmd" in
                    connect|forget)
                        # SSID auto-complete from IWD scan/known networks
                        if [[ "$cur" != -* ]]; then
                             local ssids
                             if command -v iwctl >/dev/null; then
                                 # Try to get known networks first
                                 ssids=$(iwctl known-networks list 2>/dev/null | tail -n +5 | awk '{print $1}' | sed 's/\x1b\[[0-9;]*m//g')
                             fi
                             COMPREPLY=($(compgen -W "$ssids" -- "$cur"))
                        fi
                        ;;
                    disconnect|scan|ap)
                        COMPREPLY=($(compgen -W "--interface" -- "$cur"))
                        ;;
                 esac
            fi
            ;;
        interface)
            if [ $COMP_CWORD -eq 2 ]; then
                 # Suggest interfaces OR subcommands
                 local ifaces=$(ls /sys/class/net/ 2>/dev/null)
                 COMPREPLY=($(compgen -W "$iface_cmds $ifaces" -- "$cur"))
            elif [ $COMP_CWORD -eq 3 ]; then
                 # If previous was an interface name, now we need a command
                 if [[ -d "/sys/class/net/$subcmd" ]]; then
                     COMPREPLY=($(compgen -W "$iface_cmds" -- "$cur"))
                 else
                     # Previous was a command, maybe 'set'
                     case "$subcmd" in
                        set) COMPREPLY=($(compgen -W "dhcp static" -- "$cur")) ;;
                     esac
                 fi
            fi
            ;;
        system)
            if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "$system_cmds" -- "$cur"))
            fi
            ;;
        bluetooth)
             if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "pan scan pair unpair" -- "$cur"))
             elif [ $COMP_CWORD -eq 3 ]; then
                case "$subcmd" in
                    pan) COMPREPLY=($(compgen -W "enable disable" -- "$cur")) ;;
                esac
             fi
             ;;
        bridge|bond|vrf|macvlan|ipvlan|veth)
             if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "$virt_cmds" -- "$cur"))
             fi
             ;;
        vpn|tun|tap)
             if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "wireguard tun tap" -- "$cur"))
             elif [ $COMP_CWORD -eq 3 ]; then
                if [[ "$subcmd" == "wireguard" ]]; then
                    COMPREPLY=($(compgen -W "connect disconnect delete" -- "$cur"))
                fi
             fi
             ;;
        profile)
            if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "$profile_cmds" -- "$cur"))
            elif [ $COMP_CWORD -eq 3 ]; then
                case "$subcmd" in
                    load|delete|export)
                        local profiles=$(find /storage/.config/network/profiles/global -maxdepth 1 -type d -exec basename {} \; 2>/dev/null)
                        COMPREPLY=($(compgen -W "$profiles default" -- "$cur"))
                        ;;
                esac
            fi
            ;;
        *)
            ;;
    esac
}

complete -F _rxnm_completion rxnm
complete -F _rxnm_completion rocknix-network-manager
